# 細かい仕様

## 仕様

- 投稿されるコメントの最大文字数などはチェックしておりません。
  - 良識の範囲内で正常に動作する見込みです。
- マークダウンでインジェクションされないようにサニタイズしています。
- ブログページの区別はslug単位です。
  - slugはURLの末尾のパスです。
    - 現状の仕様では、aaa/hoge, bbb/hogeはslugがどちらもhogeとなるため同じコメントを共有します。
    - slugを変更すれば対応できます。
  - URLが変わらないSPA構造のブログは想定しておりません。
    - 全ページで共通のコメント機能として使うことはできます（たぶん）。
- コメントの削除は確認せずに即時削除されます。
  - ダイアログを実装するとユーザーフレンドリーになります。
- コメントの削除は内容のみを削除します。
  - 階層構造を維持するための仕様です。
  - 削除した内容は復活できません。
- 投票した後の反映は手動リロードです
  - リアルタイム性が必要ないため仕様です。
  - GraphQLスキーマを拡張し、Subscribeすればリアルタイム更新できます。
- ログイン要求はスパム対策の目的のためです。
  - 投稿時の名前は自由に変更できます。
- 名前、書きかけのコメントはローカルストレージに保存されています。
  - ブラウザのキャッシュがクリアされると消えます。
- OAuth連携を本番運用するためには、各サービスで承認フローを完了する必要があります。
  - 各OAuthのガイドラインを遵守してください。
  - 個人的所感としては、Google > Facebook > LINEの順に審査の手間が大きいです。(2023/04現在)
  - 承認を得るために、独自ドメイン必須だと思います。
    - 独自ドメインでデプロイする場合は、Amplify Consoleで設定するとよいです。
- OAuthでログイン後には元のページに戻ります。
  - ただし、リダイレクトページにコメントフォームがないと機能しません。
- amplify codegen(あるいはpush)するとsrc/graphql/queries.tsが上書きされます。
  - replies(sortDirection: DESC)のソート指定がなくなるので、返信が日付降順に並ばなくなります。
  - restoreするか手動で追記してください。
  - graphql.schemaをどうにかすれば回避できるのかもしれません。
- ユーザーの新規アカウント作成はHosted UIから行えます。

## 機能変更へのヒント

- CORSを限定したい場合は、各functionのindex.jsのreturnにあるドメインを限定してください。
- OAuthは追加でAppleやAWSにも対応できます。
- Markdownがいらない場合は、削除するとスリムになります。
  - その際にはインジェクション対策が一緒に外れますので、別途ご対応ください。
- 投票(Voting)機能は少し修正すればUp/Downの両方に対応できます。
  - DynamoDBでは両対応できるようになっています。
- 投稿があった場合にメールで通知したいときは、CloudWatch AlermでDynamoDB書き込みを監視し、メールアドレスと紐付いたSNSをトリガーさせると簡単です。
  - amplifyのCloudFormationには組み込んでいません。
  - AWSコンソールで直接設定するとよいかと思います。
